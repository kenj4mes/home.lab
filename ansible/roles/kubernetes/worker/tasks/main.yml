---
# ==============================================================================
# ☸️ Kubernetes Worker Role
# ==============================================================================

# Check if already joined
- name: Check if node is already part of cluster
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

# Read join command
- name: Read join command from file
  ansible.builtin.slurp:
    src: /tmp/k8s_join_command
  delegate_to: localhost
  register: join_command_file
  when: not kubelet_conf.stat.exists

# Join cluster
- name: Join Kubernetes cluster
  ansible.builtin.command: "{{ join_command_file.content | b64decode }}"
  when:
    - not kubelet_conf.stat.exists
    - join_command_file is defined

# Label worker nodes
- name: Label node as worker
  ansible.builtin.command: >
    kubectl label node {{ inventory_hostname }} node-role.kubernetes.io/worker=worker --overwrite
  delegate_to: "{{ groups['k8s_control_plane'][0] }}"
  changed_when: false
