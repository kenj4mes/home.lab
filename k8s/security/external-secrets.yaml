# ==============================================================================
# üîê External Secret - Alertmanager Webhooks
# ==============================================================================
# Injects webhook URLs from Vault into Alertmanager at runtime
#
# Prerequisites:
#   1. External Secrets Operator installed
#   2. Vault configured with secrets at secret/data/homelab/alertmanager
#
# Store secrets in Vault:
#   vault kv put secret/homelab/alertmanager \
#     discord_webhook="https://discord.com/api/webhooks/..." \
#     slack_webhook="https://hooks.slack.com/services/..." \
#     pagerduty_key="your-pagerduty-key"
# ==============================================================================

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: alertmanager-webhooks
  namespace: monitoring
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: alertmanager-webhooks
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # Discord webhook URL
        discord-webhook: "{{ .discord_webhook }}"
        # Slack webhook URL
        slack-webhook: "{{ .slack_webhook }}"
        # PagerDuty service key
        pagerduty-key: "{{ .pagerduty_key }}"
  data:
    - secretKey: discord_webhook
      remoteRef:
        key: secret/data/homelab/alertmanager
        property: discord_webhook
    - secretKey: slack_webhook
      remoteRef:
        key: secret/data/homelab/alertmanager
        property: slack_webhook
    - secretKey: pagerduty_key
      remoteRef:
        key: secret/data/homelab/alertmanager
        property: pagerduty_key

---
# ClusterSecretStore for Vault
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
spec:
  provider:
    vault:
      server: "http://vault.secrets.svc:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets"
          serviceAccountRef:
            name: "external-secrets"
            namespace: "external-secrets"
