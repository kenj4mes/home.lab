# ==============================================================================
# ðŸ’¾ Longhorn - Cloud-Native Distributed Storage
# ==============================================================================
# Longhorn is a lightweight, reliable, and easy-to-use distributed block
# storage system for Kubernetes. Perfect for homelabs and edge deployments.
#
# PREREQUISITES:
#   - open-iscsi installed on all nodes: apt install open-iscsi
#   - NFSv4 client for RWX volumes: apt install nfs-common
#
# INSTALLATION (via Helm - recommended):
#   helm repo add longhorn https://charts.longhorn.io
#   helm repo update
#   helm install longhorn longhorn/longhorn \
#     --namespace longhorn-system --create-namespace \
#     --set defaultSettings.defaultReplicaCount=2 \
#     --set persistence.defaultClassReplicaCount=2 \
#     --set csi.kubeletRootDir=/var/lib/kubelet
#
# VERIFY:
#   kubectl get pods -n longhorn-system
#   kubectl get storageclasses
#
# UI ACCESS:
#   kubectl port-forward -n longhorn-system svc/longhorn-frontend 8080:80
# ==============================================================================
---
apiVersion: v1
kind: Namespace
metadata:
  name: longhorn-system
  labels:
    app.kubernetes.io/name: longhorn
    app.kubernetes.io/instance: longhorn
---
# StorageClass for Longhorn (Default)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: longhorn
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: driver.longhorn.io
allowVolumeExpansion: true
reclaimPolicy: Delete
volumeBindingMode: Immediate
parameters:
  numberOfReplicas: "2"
  staleReplicaTimeout: "2880"  # 48 hours
  fromBackup: ""
  fsType: "ext4"
---
# StorageClass for Longhorn (High Availability - 3 replicas)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: longhorn-ha
provisioner: driver.longhorn.io
allowVolumeExpansion: true
reclaimPolicy: Delete
volumeBindingMode: Immediate
parameters:
  numberOfReplicas: "3"
  staleReplicaTimeout: "2880"
  dataLocality: "best-effort"
  fsType: "ext4"
---
# StorageClass for Longhorn (Single Replica - Dev/Test)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: longhorn-single
provisioner: driver.longhorn.io
allowVolumeExpansion: true
reclaimPolicy: Delete
volumeBindingMode: Immediate
parameters:
  numberOfReplicas: "1"
  staleReplicaTimeout: "2880"
  fsType: "ext4"
---
# StorageClass for Longhorn (Backup to S3)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: longhorn-backup
provisioner: driver.longhorn.io
allowVolumeExpansion: true
reclaimPolicy: Retain  # Keep data on PVC delete
volumeBindingMode: Immediate
parameters:
  numberOfReplicas: "2"
  staleReplicaTimeout: "2880"
  recurringJobSelector: '[{"name":"backup-daily", "isGroup":true}]'
  fsType: "ext4"
---
# Recurring Job - Daily Snapshots
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: snapshot-daily
  namespace: longhorn-system
spec:
  name: snapshot-daily
  task: snapshot
  cron: "0 3 * * *"  # 3 AM daily
  retain: 7
  concurrency: 2
  groups:
    - default
---
# Recurring Job - Daily Backups to S3
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: backup-daily
  namespace: longhorn-system
spec:
  name: backup-daily
  task: backup
  cron: "0 4 * * *"  # 4 AM daily
  retain: 14
  concurrency: 1
  groups:
    - backup-daily
---
# Recurring Job - Hourly Snapshots for Critical Data
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: snapshot-hourly
  namespace: longhorn-system
spec:
  name: snapshot-hourly
  task: snapshot
  cron: "0 * * * *"  # Every hour
  retain: 24
  concurrency: 2
  labels:
    tier: critical
---
# Backup Target Configuration (S3-compatible)
# Apply after installation, or configure via Helm values
# apiVersion: longhorn.io/v1beta2
# kind: Setting
# metadata:
#   name: backup-target
#   namespace: longhorn-system
# value: "s3://homelab-backups@us-east-1/"
# ---
# apiVersion: longhorn.io/v1beta2
# kind: Setting
# metadata:
#   name: backup-target-credential-secret
#   namespace: longhorn-system
# value: "longhorn-backup-secret"
---
# Secret for S3 Backup Target
# CUSTOMIZE: Replace with your S3/MinIO credentials
apiVersion: v1
kind: Secret
metadata:
  name: longhorn-backup-secret
  namespace: longhorn-system
type: Opaque
stringData:
  # For MinIO / S3-compatible
  AWS_ACCESS_KEY_ID: "CHANGEME_ACCESS_KEY"
  AWS_SECRET_ACCESS_KEY: "CHANGEME_SECRET_KEY"
  AWS_ENDPOINTS: "https://minio.homelab.local:9000"
