# ==============================================================================
# ðŸš€ Traefik - Cloud-Native Edge Router
# ==============================================================================
# Traefik is a modern HTTP reverse proxy and load balancer that integrates
# natively with Kubernetes, Docker, and other orchestrators.
#
# INSTALLATION (via Helm - recommended):
#   helm repo add traefik https://traefik.github.io/charts
#   helm repo update
#   helm install traefik traefik/traefik \
#     --namespace traefik --create-namespace \
#     --set dashboard.enabled=true \
#     --set metrics.prometheus=true
#
# DASHBOARD ACCESS:
#   kubectl port-forward -n traefik svc/traefik 9000:9000
#   Open: http://localhost:9000/dashboard/
#
# VERIFY:
#   kubectl get pods -n traefik
#   kubectl get ingressroutes -A
# ==============================================================================
---
apiVersion: v1
kind: Namespace
metadata:
  name: traefik
  labels:
    app.kubernetes.io/name: traefik
---
# Traefik IngressRoute - Dashboard (Secure)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: traefik-dashboard
  namespace: traefik
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`traefik.homelab.local`)
      kind: Rule
      middlewares:
        - name: auth
          namespace: traefik
      services:
        - name: api@internal
          kind: TraefikService
  tls:
    certResolver: letsencrypt
---
# Middleware - Basic Auth for Dashboard
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: auth
  namespace: traefik
spec:
  basicAuth:
    secret: traefik-dashboard-auth
---
# Secret for Dashboard Auth
# Generate: htpasswd -nb admin password | base64
apiVersion: v1
kind: Secret
metadata:
  name: traefik-dashboard-auth
  namespace: traefik
type: Opaque
stringData:
  # CHANGEME: Generate with htpasswd -nb admin yourpassword
  users: "admin:$apr1$CHANGEME$hashedpassword"
---
# Middleware - Rate Limiting
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: traefik
spec:
  rateLimit:
    average: 100
    burst: 50
    period: 1m
---
# Middleware - Security Headers
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: traefik
spec:
  headers:
    frameDeny: true
    contentTypeNosniff: true
    browserXssFilter: true
    referrerPolicy: "strict-origin-when-cross-origin"
    customFrameOptionsValue: "SAMEORIGIN"
    stsSeconds: 31536000
    stsIncludeSubdomains: true
    stsPreload: true
---
# Middleware - Redirect HTTP to HTTPS
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: https-redirect
  namespace: traefik
spec:
  redirectScheme:
    scheme: https
    permanent: true
---
# Middleware - Compress Responses
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: compress
  namespace: traefik
spec:
  compress: {}
---
# Middleware Chain - Default Security
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: default-chain
  namespace: traefik
spec:
  chain:
    middlewares:
      - name: https-redirect
      - name: security-headers
      - name: compress
      - name: rate-limit
---
# Example IngressRoute
# Uncomment and customize for your services
# apiVersion: traefik.io/v1alpha1
# kind: IngressRoute
# metadata:
#   name: my-app
#   namespace: default
# spec:
#   entryPoints:
#     - websecure
#   routes:
#     - match: Host(`app.homelab.local`)
#       kind: Rule
#       middlewares:
#         - name: default-chain
#           namespace: traefik
#       services:
#         - name: my-app
#           port: 80
#   tls:
#     certResolver: letsencrypt
