# ==============================================================================
# üé® HomeLab Creative AI Stack - Docker Compose
# ==============================================================================
# Multi-modal AI generation services for text-to-image, audio, video, and 3D.
#
# Services:
#   - stable-diffusion:  Automatic1111 WebUI for text-to-image generation
#   - comfyui:           Node-based workflow for advanced diffusion pipelines
#   - bark-tts:          Text-to-speech with voice cloning and sound effects
#   - faster-whisper:    Fast speech-to-text transcription (GPU accelerated)
#   - musicgen:          AI music generation from text prompts
#   - video-diffusion:   Stable Video Diffusion for text/image-to-video
#
# Usage:
#   docker compose -f docker-compose.creative.yml up -d
#   docker compose -f docker-compose.creative.yml --profile gpu up -d
#
# GPU Support:
#   Requires NVIDIA GPU with CUDA drivers and nvidia-container-toolkit
#   Most services need 8GB+ VRAM for optimal performance
#
# ==============================================================================

name: homelab

networks:
  homelab:
    name: homelab
    external: true
  creative-internal:
    name: creative-internal
    internal: true

volumes:
  sd-models:
    name: homelab-sd-models
  sd-outputs:
    name: homelab-sd-outputs
  comfyui-models:
    name: homelab-comfyui-models
  comfyui-outputs:
    name: homelab-comfyui-outputs
  bark-models:
    name: homelab-bark-models
  whisper-models:
    name: homelab-whisper-models
  musicgen-models:
    name: homelab-musicgen-models
  video-diffusion-models:
    name: homelab-video-diffusion-models

# ------------------------------------------------------------------------------
# Common settings for all services
# ------------------------------------------------------------------------------
x-common: &common
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

x-gpu-resources: &gpu-resources
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]

services:
  # ============================================================================
  # üñºÔ∏è Stable Diffusion - Automatic1111 WebUI
  # ============================================================================
  # The most popular text-to-image interface with extensive plugin ecosystem.
  # Features: txt2img, img2img, inpainting, ControlNet, LoRA, extensions
  # URL: http://localhost:7860
  # ============================================================================
  stable-diffusion:
    image: goolashe/automatic1111-sd-webui:latest
    container_name: stable-diffusion
    profiles:
      - creative
      - image-gen
      - gpu
    ports:
      - "7860:7860"
    volumes:
      - sd-models:/stable-diffusion-webui/models
      - sd-outputs:/stable-diffusion-webui/outputs
      - ${SD_CONFIG_PATH:-./configs/stable-diffusion}:/stable-diffusion-webui/config
    environment:
      - COMMANDLINE_ARGS=--listen --port 7860 --api --enable-insecure-extension-access
      - NVIDIA_VISIBLE_DEVICES=all
      - CUDA_VISIBLE_DEVICES=0
    networks:
      - homelab
      - creative-internal
    <<: [*common, *gpu-resources]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860/sdapi/v1/options"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 120s
    labels:
      - "com.homelab.service=stable-diffusion"
      - "com.homelab.category=creative"
      - "com.homelab.description=Automatic1111 Stable Diffusion WebUI"
      - "com.homelab.gpu=required"

  # ============================================================================
  # üîÄ ComfyUI - Node-based Workflow Engine
  # ============================================================================
  # Graph-based diffusion pipeline builder for advanced workflows.
  # Features: Custom nodes, video frame-by-frame, AnimateDiff, IPAdapter
  # URL: http://localhost:8188
  # ============================================================================
  comfyui:
    image: saladtechnologies/comfyui:latest
    container_name: comfyui
    profiles:
      - creative
      - image-gen
      - gpu
    ports:
      - "8188:8188"
    volumes:
      - comfyui-models:/ComfyUI/models
      - comfyui-outputs:/ComfyUI/output
      - ${COMFYUI_CONFIG_PATH:-./configs/comfyui}:/ComfyUI/custom_nodes
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    networks:
      - homelab
      - creative-internal
    <<: [*common, *gpu-resources]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8188/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.homelab.service=comfyui"
      - "com.homelab.category=creative"
      - "com.homelab.description=ComfyUI Node-based Diffusion Workflow"
      - "com.homelab.gpu=required"

  # ============================================================================
  # üó£Ô∏è Bark TTS - Text-to-Speech & Audio Generation
  # ============================================================================
  # Neural text-to-speech with voice cloning and sound effect generation.
  # Features: Multilingual, expressive voices, music, SFX, laughter
  # API: POST http://localhost:5010/synthesize {"text": "Hello world"}
  # ============================================================================
  bark-tts:
    build:
      context: ../miniapps/bark-tts
      dockerfile: Dockerfile
    image: homelab/bark-tts:latest
    container_name: bark-tts
    profiles:
      - creative
      - audio
      - gpu
    ports:
      - "5010:5000"
    volumes:
      - bark-models:/app/models
    environment:
      - BARK_SMALL_MODEL=${BARK_SMALL_MODEL:-false}
      - BARK_USE_GPU=${BARK_USE_GPU:-true}
      - NVIDIA_VISIBLE_DEVICES=all
    networks:
      - homelab
      - creative-internal
    <<: [*common, *gpu-resources]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.homelab.service=bark-tts"
      - "com.homelab.category=creative"
      - "com.homelab.description=Bark Text-to-Speech"
      - "com.homelab.gpu=optional"

  # ============================================================================
  # üé§ Faster-Whisper - Speech-to-Text
  # ============================================================================
  # GPU-accelerated transcription using CTranslate2 optimized Whisper.
  # Features: Real-time transcription, language detection, timestamps
  # API: POST http://localhost:5011/transcribe (multipart file upload)
  # ============================================================================
  faster-whisper:
    image: linuxserver/faster-whisper:latest
    container_name: faster-whisper
    profiles:
      - creative
      - audio
      - gpu
    ports:
      - "5011:5000"
    volumes:
      - whisper-models:/config/models
      - ${AUDIO_PATH:-./data/audio}:/audio
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Etc/UTC}
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - WHISPER_BEAM=5
    networks:
      - homelab
      - creative-internal
    <<: *common
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "com.homelab.service=faster-whisper"
      - "com.homelab.category=creative"
      - "com.homelab.description=Faster-Whisper Speech-to-Text"
      - "com.homelab.gpu=optional"

  # ============================================================================
  # üéµ MusicGen - AI Music Generation
  # ============================================================================
  # Meta's AudioCraft music generation model.
  # Features: Text-to-music, melody conditioning, up to 30s generation
  # API: POST http://localhost:5012/generate {"prompt": "epic orchestral..."}
  # ============================================================================
  musicgen:
    build:
      context: ../miniapps/musicgen
      dockerfile: Dockerfile
    image: homelab/musicgen:latest
    container_name: musicgen
    profiles:
      - creative
      - audio
      - gpu
    ports:
      - "5012:5000"
    volumes:
      - musicgen-models:/app/models
    environment:
      - MUSICGEN_MODEL=${MUSICGEN_MODEL:-small}
      - NVIDIA_VISIBLE_DEVICES=all
    networks:
      - homelab
      - creative-internal
    <<: [*common, *gpu-resources]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    labels:
      - "com.homelab.service=musicgen"
      - "com.homelab.category=creative"
      - "com.homelab.description=MusicGen AI Music Generation"
      - "com.homelab.gpu=required"

  # ============================================================================
  # üé¨ Stable Video Diffusion - Text/Image to Video
  # ============================================================================
  # Generate short video clips from images or text prompts.
  # Features: Image-to-video, motion control, up to 4 seconds @ 14fps
  # API: POST http://localhost:5013/generate {"image": base64, "frames": 14}
  # ============================================================================
  video-diffusion:
    build:
      context: ../miniapps/video-diffusion
      dockerfile: Dockerfile
    image: homelab/video-diffusion:latest
    container_name: video-diffusion
    profiles:
      - creative
      - video
      - gpu
    ports:
      - "5013:5000"
    volumes:
      - video-diffusion-models:/app/models
      - ${VIDEO_OUTPUT_PATH:-./data/videos}:/app/outputs
    environment:
      - SVD_MODEL=${SVD_MODEL:-svd-xt}
      - NVIDIA_VISIBLE_DEVICES=all
    networks:
      - homelab
      - creative-internal
    <<: [*common, *gpu-resources]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 180s
    labels:
      - "com.homelab.service=video-diffusion"
      - "com.homelab.category=creative"
      - "com.homelab.description=Stable Video Diffusion"
      - "com.homelab.gpu=required"

  # ============================================================================
  # üìä Creative Dashboard - Unified UI
  # ============================================================================
  # Web dashboard to access all creative services from one interface.
  # URL: http://localhost:8190
  # ============================================================================
  creative-dashboard:
    build:
      context: ../miniapps/creative-dashboard
      dockerfile: Dockerfile
    image: homelab/creative-dashboard:latest
    container_name: creative-dashboard
    profiles:
      - creative
    ports:
      - "8190:80"
    environment:
      - SD_URL=http://stable-diffusion:7860
      - COMFYUI_URL=http://comfyui:8188
      - BARK_URL=http://bark-tts:5000
      - WHISPER_URL=http://faster-whisper:5000
      - MUSICGEN_URL=http://musicgen:5000
      - VIDEO_DIFFUSION_URL=http://video-diffusion:5000
    networks:
      - homelab
      - creative-internal
    <<: *common
    depends_on:
      - stable-diffusion
      - comfyui
      - bark-tts
      - faster-whisper
      - musicgen
      - video-diffusion
    labels:
      - "com.homelab.service=creative-dashboard"
      - "com.homelab.category=creative"
      - "com.homelab.description=Creative AI Dashboard"

# ==============================================================================
# Notes:
# ==============================================================================
#
# VRAM Requirements (minimum):
#   - Stable Diffusion: 4GB (8GB+ recommended for SDXL)
#   - ComfyUI: 4GB (8GB+ for SDXL, 12GB+ for video workflows)
#   - Bark TTS: 4GB (can use CPU with slower performance)
#   - Faster-Whisper: 2GB (can use CPU)
#   - MusicGen: 4GB small / 8GB medium / 16GB large
#   - Video Diffusion: 12GB+ (24GB for highest quality)
#
# Model Downloads:
#   Models are automatically downloaded on first run.
#   For offline operation, pre-download and place in volumes:
#   - SD models: sd-models:/stable-diffusion-webui/models
#   - ComfyUI: comfyui-models:/ComfyUI/models
#
# API Integration with AI Agents:
#   All services expose REST APIs that can be called from LangGraph agents:
#
#   Generate image:
#     POST http://stable-diffusion:7860/sdapi/v1/txt2img
#     {"prompt": "...", "steps": 20, "width": 512, "height": 512}
#
#   Generate music:
#     POST http://musicgen:5000/generate
#     {"prompt": "epic orchestral theme", "duration": 10}
#
#   Text to speech:
#     POST http://bark-tts:5000/synthesize
#     {"text": "Hello world", "voice": "v2/en_speaker_6"}
#
# ==============================================================================
