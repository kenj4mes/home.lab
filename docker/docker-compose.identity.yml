# ==============================================================================
# üîê Identity Stack - Keycloak SSO + OAuth
# ==============================================================================
# Centralized Identity Provider for Single Sign-On
#
# Access: http://localhost:8180
# Admin Console: http://localhost:8180/admin
# Default: admin / ${KEYCLOAK_ADMIN_PASSWORD}
#
# Usage:
#   docker compose -f docker-compose.identity.yml up -d
# ==============================================================================

name: homelab

networks:
  homelab:
    external: true
  identity:
    name: identity
    driver: bridge

volumes:
  keycloak-data:
  keycloak-db:

services:
  # ============================================================================
  # üóÑÔ∏è KEYCLOAK DATABASE - PostgreSQL
  # ============================================================================
  keycloak-db:
    image: postgres:15-alpine
    container_name: keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-CHANGEME_KEYCLOAK_DB}
    volumes:
      - keycloak-db:/var/lib/postgresql/data
    networks:
      - identity
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # üîê KEYCLOAK - Identity Provider
  # ============================================================================
  # Features:
  #   - Single Sign-On (SSO) via OIDC/SAML
  #   - Multi-Factor Authentication (MFA)
  #   - User Federation (LDAP, AD)
  #   - Social Login (Google, GitHub)
  # ============================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    command: start
    environment:
      # Admin credentials
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-CHANGEME_KEYCLOAK_ADMIN}
      
      # Database
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-CHANGEME_KEYCLOAK_DB}
      
      # Proxy settings (behind reverse proxy)
      KC_PROXY: edge
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      
      # Features
      KC_FEATURES: token-exchange,admin-fine-grained-authz
      
      # Health
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    ports:
      - "8180:8080"
    networks:
      - homelab
      - identity
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful'; exit 0; else echo 'Healthcheck Failed'; exit 1; fi;"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ============================================================================
  # üîÑ OAUTH2 PROXY - Authentication Sidecar
  # ============================================================================
  # Protects any HTTP service with Keycloak authentication
  # ============================================================================
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: oauth2-proxy
    command:
      - --http-address=0.0.0.0:4180
      - --provider=keycloak-oidc
      - --client-id=${OAUTH2_CLIENT_ID:-homelab}
      - --client-secret=${OAUTH2_CLIENT_SECRET:-CHANGEME_OAUTH_SECRET}
      - --oidc-issuer-url=http://keycloak:8080/realms/homelab
      - --cookie-secret=${OAUTH2_COOKIE_SECRET:-CHANGEME_32_CHAR_SECRET_HERE!!}
      - --cookie-secure=false
      - --email-domain=*
      - --upstream=static://202
      - --skip-provider-button=true
      - --pass-access-token=true
      - --pass-user-headers=true
      - --set-xauthrequest=true
    ports:
      - "4180:4180"
    networks:
      - homelab
      - identity
    depends_on:
      keycloak:
        condition: service_healthy
    restart: unless-stopped
