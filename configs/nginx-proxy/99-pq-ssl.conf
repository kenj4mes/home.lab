# ============================================================================
# 99-pq-ssl.conf - Post-Quantum Hybrid TLS Configuration
# ============================================================================
# This configuration enables hybrid TLS 1.3 with post-quantum key exchange
# (Kyber-768) and classical ECDHE for backwards compatibility.
#
# Mount this file in Nginx Proxy Manager:
#   volumes:
#     - ./nginx-proxy/99-pq-ssl.conf:/etc/nginx/conf.d/99-pq-ssl.conf:ro
#
# Requirements:
#   - OpenSSL 3.1+ with OQS provider (run install-quantum.sh)
#   - Hybrid TLS certificates (run generate-pq-tls.sh)
#
# ============================================================================

# -------------------------------------------------
# SSL Protocol Configuration
# -------------------------------------------------

# TLS 1.3 only for post-quantum support
ssl_protocols TLSv1.3;

# Prefer server ciphers
ssl_prefer_server_ciphers on;

# TLS 1.3 cipher suites (in order of preference)
ssl_ciphersuites 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256';

# -------------------------------------------------
# Post-Quantum Key Exchange (when OQS available)
# -------------------------------------------------
# These directives enable hybrid KEM when OpenSSL OQS provider is loaded.
# Browsers that support PQ (Chrome 124+, Firefox 124+) will negotiate Kyber.
# Older browsers fall back to classical ECDHE.

# Note: Uncomment these when OQS provider is active:
# ssl_conf_command Curves X25519Kyber768Draft00:X25519:P-256;
# ssl_ecdh_curve X25519:secp384r1:secp256r1;

# Standard ECDH curve configuration (fallback)
ssl_ecdh_curve X25519:secp384r1:secp256r1;

# -------------------------------------------------
# Certificate Configuration
# -------------------------------------------------

# Hybrid certificates (if using custom certs from generate-pq-tls.sh)
# Uncomment and adjust paths as needed:
# ssl_certificate     /data/nginx/ssl/hybrid-chain.crt;
# ssl_certificate_key /data/nginx/ssl/hybrid.key;

# DH parameters for older TLS versions (if needed)
# ssl_dhparam         /data/nginx/ssl/dhparam.pem;

# -------------------------------------------------
# Session Configuration
# -------------------------------------------------

# Enable session resumption for performance
ssl_session_cache shared:SSL:50m;
ssl_session_timeout 1d;

# Session tickets (disable for forward secrecy)
ssl_session_tickets off;

# -------------------------------------------------
# OCSP Stapling
# -------------------------------------------------

# Enable OCSP stapling (if using public CA)
# ssl_stapling on;
# ssl_stapling_verify on;
# resolver 1.1.1.1 8.8.8.8 valid=300s;
# resolver_timeout 5s;

# -------------------------------------------------
# Security Headers
# -------------------------------------------------

# HTTP Strict Transport Security (HSTS)
# Only enable if you control all subdomains
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Clickjacking protection
add_header X-Frame-Options "SAMEORIGIN" always;

# XSS protection
add_header X-XSS-Protection "1; mode=block" always;

# Referrer policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# -------------------------------------------------
# Performance Optimizations
# -------------------------------------------------

# Buffer sizes
ssl_buffer_size 4k;

# Early data (0-RTT) - disable for security
ssl_early_data off;

# -------------------------------------------------
# Logging
# -------------------------------------------------

# Log SSL handshake details (for debugging)
# log_format ssl_debug '$remote_addr - $remote_user [$time_local] '
#                      '"$request" $status $body_bytes_sent '
#                      '"$http_referer" "$http_user_agent" '
#                      '$ssl_protocol $ssl_cipher';

# ============================================================================
# Post-Quantum Readiness Notes:
# ============================================================================
#
# This configuration is "PQ-ready" - when OpenSSL with OQS provider is
# installed and enabled, clients will automatically negotiate:
#
#   - Key Exchange: X25519Kyber768 (hybrid classical + post-quantum)
#   - Signature: ECDSA P-256 (classical, PQ signatures pending wider support)
#
# To verify PQ is active:
#   openssl s_client -connect proxy.local:443 -servername proxy.local 2>&1 | grep -i "kyber\|dilithium"
#
# Browser support:
#   - Chrome 124+: Supports Kyber768
#   - Firefox 124+: Supports Kyber768
#   - Safari: Classical only (as of 2024)
#   - Edge 124+: Supports Kyber768
#
# ============================================================================
